#!/bin/bash
PROGRAM=$(basename $0)
read -r -d '' USAGE <<HEREDOC
Usage: $PROGRAM [options] <seed_mpet.fa> <pet_read1.fq> <pet_read2.fq>
Gather PET reads for targeted assembly of MPET fragment(s).

Options:
    -a FILE   align reads to reference genome FILE after
              each iteration [disabled]
    -h        show this help message
    -j N      threads [1]
    -k N      k-mer size for read overlap detection [25]
    -m N      max iterations for recruiting PET reads [10]
    -n N      max k-mers to recruit in total [25000]
    -o FILE   output file prefix ['kollector']
    -r FILE   Bloom filter containing repeat k-mers for
              exclusion from scoring calculations; must match
              k-mer size selected with -k opt [disabled]
    -s N      min score for recruiting seed PETs using seed MPETs;
              floating point number between 0 and 1 [0.5]
    -S N      min score for recruiting PETs from seed PETs and MPETs;
              floating point number between 0 and 1 [0.3]
HEREDOC

set -eu -o pipefail

# default values for options
max_iterations=15
j=1
k=25
prefix=kollect
s=0.5
max_kmers=25000
S=0.3
help=0

# parse command line options
while getopts :a:d:hj:k:m:n:o:r:s:S: opt; do
	case $opt in
		a) ref=$OPTARG;;
		d) mpet_dist=$OPTARG;;
		h) help=1;;
		j) j=$OPTARG;;
		k) k=$OPTARG;;
		m) max_iterations=$OPTARG;;
		n) max_kmers=$OPTARG;;
		o) prefix=$OPTARG;;
		r) r=$OPTARG;;
		s) s=$OPTARG;;
		S) S=$OPTARG;;
		\?) echo "$PROGRAM: invalid option: $OPTARG"; exit 1;;
	esac
done
shift $((OPTIND-1))

# -h for help message
if [ $help -ne 0 ]; then
	echo "$USAGE"
	exit 0;
fi

# we expect exactly 3 file arguments
if [ $# -ne 3 ]; then
	echo "$USAGE" >&2
	exit 1;
fi
seed_mp=$1; shift;
pet1=$1; shift;
pet2=$1; shift;

function heading() {
	echo '-----------------------------------------'
	echo "$@"
	echo '-----------------------------------------'
}

heading "Recruiting a maximum of $max_kmers k-mers"

# align seed MPETs
if [ "${ref+defined}" = 'defined' ]; then
	heading "Aligning seed MPET reads..."
	kollector-align.mk query=$seed_mp ref=$ref j=$j
fi

# build seed FASTA file for recruiting PET reads
heading 'Building seed FASTA file...'
kollector-tag.mk name=$prefix seed_mp=$seed_mp pe="$pet1 $pet2" \
	n=$max_kmers j=$j s=$s k=$k ${r+subtract=$r}

# align seed MPETs and PETs
if [ "${ref+defined}" = 'defined' ]; then
	heading "Aligning seed MPET and PET reads..."
	kollector-align.mk query=$prefix.seed.fa ref=$ref j=$j
fi

for i in $(seq 1 $max_iterations); do

	# recruit PETs with paired overlap to previously recruited PETs
	heading "Recruiting PET reads (iteration $i)..."
	if [ $i -eq 1 ]; then
		seed=$prefix.seed.fa
	else
		seed=$prefix-$(($i-1)).fa
	fi
	kollector-recruit.mk name=$prefix-$i seed=$seed pe="$pet1 $pet2" \
		s=$S n=$max_kmers j=$j k=$k ${r+subtract=$r}

	# align PETs gathered so far to reference genome (debugging)
	if [ "${ref+defined}" = 'defined' ]; then
		heading "Aligning PET reads (iteration $i)..."
		kollector-align.mk query=$prefix-$i.fa ref=$ref j=$j
	fi
	
	# check for stopping condition
	kmers=$(awk -F= '$1=="num_entries" {print $2}' $prefix-$i.txt)
	heading "Recruited $kmers distinct k-mers so far (iteration $i)..."
	if [ $kmers -ge $max_kmers ]; then
		heading "Stopping. Recruited k-mers ($kmers) exceeded limit ($max_kmers)"
		break
	fi

done
rm -f $prefix.fa
ln -s $prefix-$i.fa $prefix.fa
